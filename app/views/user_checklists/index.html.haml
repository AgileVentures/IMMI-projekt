%header.entry-header
  %h1{ class: with_admin_css_class_if_needed(@current_user, ['entry-title']) }=  t('.title', name: @user.full_name)


.entry-content
  #user-checklists
    - unless @user_checklists.empty?
      = arranged_tree_as_list(@user_checklists.arrange,
           {sort_by: [:list_position],
           list_type: 'ol',
            ul_class: ['checklist'],
            ul_class_top: ['top'],
            ul_class_children: ['children', 'collapse', 'show'],
            ul_id_method: ul_id,
            li_class: ['checklist-item'],
            li_id_method: li_id}) do | child_entry |

        - child_entry_li_id = li_id.call(child_entry)
        - disabled_setting = {}

        -if child_entry.has_children?
          - children_ul_id = "##{ul_id.call(child_entry)}"
          - disabled_setting = {disabled: true}

          %i{class:'expand-collapse-toggle fa fa-angle-down' ,'aria-controls': children_ul_id, 'aria-expanded': 'true', 'data-toggle': 'collapse', href: children_ul_id, role: 'button' }

        = check_box_tag("completed-checkbox-#{child_entry_li_id}", 'checked', child_entry.all_completed?, { class: "checkbox-date-completed",
           onchange:"toggleCompletedCheckbox(#{current_user.id}, #{child_entry.id}, '#{child_entry_li_id}')" }.merge(disabled_setting))

        %span.name{ class: list_entry_css_classes(child_entry) }
          = child_entry.name

        %span.date-completed
          - if  child_entry.all_completed?
            Date completed: #{child_entry.date_completed.to_date}

        - unless child_entry.ancestors?
          -# only show progress bar for the top level items
          - percent_complete = child_entry.percent_complete
          %div.progress{style: "width: 20rem; display: inline-flex;"}
            %div.progress-bar.bg-success{role: 'progressbar', style: "width: #{percent_complete}%", 'aria-valuenow':"#{percent_complete}", 'aria-valuemin': '0', 'aria-valuemax': '100'}
              = "#{percent_complete}%"



:javascript

  // FIXME - DRY with show_progress javascript

  $(".expand-collapse-toggle").on("click",function(){
    $(this).toggleClass("fa-angle-down");
    $(this).toggleClass("fa-angle-up");
  });


  function toggleCompletedCheckbox(userId, checklistId, elementId) {
      let ajaxPostURL = "/en/anvandare/" + userId + "/lista/" + checklistId + "/all_changed_by_completion_toggle";
      $.post( ajaxPostURL,  updateDateSuccessfulFor); // FIXME catch error and display as an alert
      // TODO udpate percent complete
  }


  // FIXME also update the progress bars for top-level lists

  // Loop through all items returned in the response and update their date completed display.
  function updateDateSuccessfulFor(responseData) {
    let changedChecklists = responseData.changed_checklists;

    changedChecklists.forEach(function(checklist){

      let checklistLiID = ("li-id-" + String(checklist['checklist_id']));
      let checklistDateCompleted = checklist['date_completed'];
      let dateCompleted = getDateCompletedForElement(checklistLiID);

      console.log(checklist);
      dateCompleted.innerHTML = ''; // clear existing
      // FIXME i18n for the text node
      dateCompleted.appendChild( document.createTextNode("Date completed: " +  checklistDateCompleted) );
      setCheckboxBasedOnDateCompleted(checklistLiID, checklistDateCompleted)
      displayOrHideDateCompleted(checklistLiID);
    });
  }


  function setCheckboxBasedOnDateCompleted(liElementId, dateCompleted) {
    let element = document.getElementById(liElementId);
    let checkBox = element.getElementsByClassName("checkbox-date-completed")[0];
    checkBox.checked = !!dateCompleted  // this turns null and empty Strings into false (a Boolean)
  }


  // show the date completed if completed checkbox in the element is checked; hide otherwise
  function displayOrHideDateCompleted(elementId) {
    let element = document.getElementById(elementId);
    let checkBox = element.getElementsByClassName("checkbox-date-completed")[0];
    let dateCompleted = getDateCompletedForElement(elementId);
    dateCompleted.style.display = (checkBox.checked ? "inline-block" : "none");
  }


  function getDateCompletedForElement(elementId) {
    let element = document.getElementById(elementId);
    return element.getElementsByClassName("date-completed")[0];
  }
